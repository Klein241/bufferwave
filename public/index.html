<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>BufferWave</title>
  <link rel="manifest" href="/manifest.json"/>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Share+Tech+Mono&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#0a0f1e;--accent:#00f5c4;--accent2:#0084ff;--danger:#ff4060;--text:#e0eeff;--muted:#4a6080;--border:rgba(0,245,196,0.15)}
    *{margin:0;padding:0;box-sizing:border-box}
    body{background:var(--bg);color:var(--text);font-family:'Share Tech Mono',monospace;min-height:100vh;display:flex;flex-direction:column;align-items:center}
    body::before{content:'';position:fixed;inset:0;background-image:linear-gradient(rgba(0,245,196,0.03) 1px,transparent 1px),linear-gradient(90deg,rgba(0,245,196,0.03) 1px,transparent 1px);background-size:40px 40px;pointer-events:none}
    .container{position:relative;z-index:1;width:100%;max-width:480px;padding:24px 16px 40px}
    header{text-align:center;margin-bottom:28px}
    .logo{font-family:'Orbitron',monospace;font-weight:900;font-size:2rem;letter-spacing:4px;background:linear-gradient(135deg,var(--accent),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
    .tagline{color:var(--muted);font-size:.75rem;letter-spacing:2px;margin-top:4px;text-transform:uppercase}
    .auth-box{background:rgba(255,255,255,0.04);border:1px solid var(--border);border-radius:12px;padding:20px;margin-bottom:20px}
    .auth-box input{width:100%;background:rgba(0,0,0,0.3);border:1px solid var(--border);border-radius:8px;padding:10px 14px;color:var(--text);font-family:'Share Tech Mono',monospace;font-size:.85rem;margin-bottom:10px;outline:none}
    .auth-box input:focus{border-color:var(--accent)}
    .btn-auth{width:100%;padding:12px;background:linear-gradient(135deg,rgba(0,245,196,0.2),rgba(0,132,255,0.2));border:1px solid var(--accent);border-radius:8px;color:var(--accent);font-family:'Orbitron',monospace;font-size:.75rem;letter-spacing:2px;cursor:pointer;transition:all .3s}
    .btn-auth:hover{background:linear-gradient(135deg,rgba(0,245,196,0.4),rgba(0,132,255,0.4))}
    .network-bar{display:flex;align-items:center;justify-content:space-between;background:rgba(255,255,255,0.04);border:1px solid var(--border);border-radius:10px;padding:12px 16px;margin-bottom:16px;font-size:.7rem}
    .net-dot{width:8px;height:8px;border-radius:50%;background:var(--accent);display:inline-block;margin-right:8px}
    .net-dot.offline{background:var(--danger)}
    .net-dot.online{animation:pulse 1.5s infinite}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}
    .battery-section{display:flex;flex-direction:column;align-items:center;margin-bottom:28px}
    .battery-wrap{position:relative;width:160px;height:290px}
    .battery-tip{position:absolute;top:0;left:50%;transform:translateX(-50%);width:46px;height:20px;border:2px solid var(--accent);border-bottom:none;border-radius:6px 6px 0 0;background:rgba(0,245,196,0.05)}
    .battery-body{position:absolute;bottom:0;left:0;right:0;height:268px;border:2px solid var(--accent);border-radius:10px;overflow:hidden;background:rgba(0,245,196,0.02);box-shadow:0 0 20px rgba(0,245,196,0.1)}
    .battery-fill{position:absolute;bottom:0;left:0;right:0;height:0%;background:linear-gradient(180deg,var(--accent2),var(--accent));transition:height .8s cubic-bezier(.4,0,.2,1)}
    .battery-percent{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-family:'Orbitron',monospace;font-size:2rem;font-weight:900;color:white;text-shadow:0 0 20px rgba(0,245,196,0.8);z-index:2}
    .battery-label{position:absolute;bottom:16px;left:50%;transform:translateX(-50%);font-size:.6rem;color:rgba(255,255,255,0.5);letter-spacing:2px;white-space:nowrap;z-index:2}
    .bubble{position:absolute;width:6px;height:6px;background:rgba(255,255,255,0.3);border-radius:50%;animation:rise 3s ease-in infinite;display:none}
    .mode-charge .bubble{display:block}
    @keyframes rise{0%{bottom:5%;opacity:1}100%{bottom:95%;opacity:0}}
    .bubble:nth-child(1){left:20%;animation-delay:0s}
    .bubble:nth-child(2){left:50%;animation-delay:.8s}
    .bubble:nth-child(3){left:75%;animation-delay:1.6s}
    .battery-stats{display:flex;gap:20px;margin-top:16px;text-align:center}
    .stat-val{font-family:'Orbitron',monospace;font-size:1rem;color:var(--accent)}
    .stat-lbl{font-size:.6rem;color:var(--muted);letter-spacing:1px;text-transform:uppercase}
    .mode-badge{display:inline-flex;align-items:center;gap:8px;padding:6px 16px;border-radius:20px;font-size:.7rem;letter-spacing:2px;text-transform:uppercase;margin-top:12px;transition:all .4s}
    .mode-badge.standby{background:rgba(74,96,128,0.2);border:1px solid var(--muted);color:var(--muted)}
    .mode-badge.charging{background:rgba(0,132,255,0.15);border:1px solid var(--accent2);color:var(--accent2);box-shadow:0 0 12px rgba(0,132,255,0.2)}
    .mode-badge.discharging{background:rgba(0,245,196,0.15);border:1px solid var(--accent);color:var(--accent);box-shadow:0 0 12px rgba(0,245,196,0.2)}
    .mode-dot{width:7px;height:7px;border-radius:50%;background:currentColor}
    .mode-badge.charging .mode-dot,.mode-badge.discharging .mode-dot{animation:pulse 1.2s infinite}
    .controls{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px}
    .btn{padding:18px 12px;border:none;border-radius:12px;font-family:'Orbitron',monospace;font-size:.65rem;font-weight:700;letter-spacing:2px;text-transform:uppercase;cursor:pointer;transition:all .3s}
    .btn-charge{background:rgba(0,132,255,0.15);border:1px solid rgba(0,132,255,0.5);color:var(--accent2)}
    .btn-charge:hover,.btn-charge.active{background:rgba(0,132,255,0.35);box-shadow:0 0 20px rgba(0,132,255,0.3);transform:translateY(-2px)}
    .btn-discharge{background:rgba(0,245,196,0.15);border:1px solid rgba(0,245,196,0.5);color:var(--accent)}
    .btn-discharge:hover,.btn-discharge.active{background:rgba(0,245,196,0.35);box-shadow:0 0 20px rgba(0,245,196,0.3);transform:translateY(-2px)}
    .btn-icon{display:block;font-size:1.4rem;margin-bottom:6px}
    .btn-hotspot{width:100%;padding:14px;background:rgba(255,64,96,0.1);border:1px solid rgba(255,64,96,0.4);color:var(--danger);border-radius:12px;font-family:'Orbitron',monospace;font-size:.65rem;font-weight:700;letter-spacing:2px;text-transform:uppercase;cursor:pointer;transition:all .3s;margin-bottom:16px;display:flex;align-items:center;justify-content:center;gap:10px}
    .btn-hotspot:hover,.btn-hotspot.active{background:rgba(255,64,96,0.3);box-shadow:0 0 20px rgba(255,64,96,0.2)}
    .log-section{background:rgba(255,255,255,0.04);border:1px solid var(--border);border-radius:12px;overflow:hidden}
    .log-header{display:flex;align-items:center;gap:8px;padding:10px 14px;border-bottom:1px solid var(--border);font-size:.7rem;color:var(--muted);letter-spacing:2px}
    .log-dot{width:8px;height:8px;border-radius:50%;background:var(--accent);animation:pulse 2s infinite}
    .log-body{padding:12px 14px;height:130px;overflow-y:auto;display:flex;flex-direction:column-reverse;gap:4px}
    .log-line{font-size:.68rem;line-height:1.5}
    .log-line.info{color:var(--accent2)}
    .log-line.success{color:var(--accent)}
    .log-line.warn{color:#ffaa00}
    .log-line.error{color:var(--danger)}
    .hidden{display:none!important}
    .user-bar{display:flex;align-items:center;justify-content:space-between;background:rgba(255,255,255,0.04);border:1px solid var(--border);border-radius:10px;padding:10px 14px;margin-bottom:16px;font-size:.7rem}
    .btn-logout{background:none;border:1px solid var(--muted);color:var(--muted);border-radius:6px;padding:4px 10px;font-family:'Share Tech Mono',monospace;font-size:.65rem;cursor:pointer}
    .btn-logout:hover{border-color:var(--danger);color:var(--danger)}
    /* Bandeau r√©seau coop√©ratif */
    .relay-bar{display:flex;align-items:center;justify-content:space-between;background:rgba(0,245,196,0.05);border:1px solid rgba(0,245,196,0.2);border-radius:10px;padding:10px 14px;margin-bottom:16px;font-size:.7rem}
    .relay-info{color:var(--accent);font-size:.65rem}
    .relay-count{font-family:'Orbitron',monospace;color:var(--accent);font-size:.9rem}
  </style>
</head>
<body>
<div class="container">
  <header>
    <div class="logo">BUFFERWAVE</div>
    <div class="tagline">Batterie de Connexion Internet</div>
  </header>

  <!-- AUTH -->
  <div id="authBox" class="auth-box">
    <!-- Onglets -->
    <div style="display:flex;gap:8px;margin-bottom:16px">
      <button id="tabLogin" onclick="switchTab('login')" style="flex:1;padding:8px;background:rgba(0,245,196,0.2);border:1px solid var(--accent);border-radius:8px;color:var(--accent);font-family:'Orbitron',monospace;font-size:.65rem;letter-spacing:2px;cursor:pointer">CONNEXION</button>
      <button id="tabRegister" onclick="switchTab('register')" style="flex:1;padding:8px;background:transparent;border:1px solid var(--muted);border-radius:8px;color:var(--muted);font-family:'Orbitron',monospace;font-size:.65rem;letter-spacing:2px;cursor:pointer">INSCRIPTION</button>
    </div>

    <input type="email" id="emailInput" placeholder="Email"/>

    <!-- Champ mot de passe avec ≈ìil -->
    <div style="position:relative;margin-bottom:10px">
      <input type="password" id="passInput" placeholder="Mot de passe" style="width:100%;background:rgba(0,0,0,0.3);border:1px solid var(--border);border-radius:8px;padding:10px 40px 10px 14px;color:var(--text);font-family:'Share Tech Mono',monospace;font-size:.85rem;outline:none;margin-bottom:0"/>
      <button onclick="togglePass()" style="position:absolute;right:10px;top:50%;transform:translateY(-50%);background:none;border:none;color:var(--muted);cursor:pointer;font-size:1rem" id="eyeBtn">üëÅ</button>
    </div>

    <!-- Confirmation mot de passe (inscription uniquement) -->
    <div id="confirmBox" style="position:relative;margin-bottom:10px;display:none">
      <input type="password" id="passConfirm" placeholder="Confirmer le mot de passe" style="width:100%;background:rgba(0,0,0,0.3);border:1px solid var(--border);border-radius:8px;padding:10px 14px;color:var(--text);font-family:'Share Tech Mono',monospace;font-size:.85rem;outline:none"/>
    </div>

    <button class="btn-auth" id="btnAuth" onclick="login()">SE CONNECTER</button>
    <div id="authMsg" style="margin-top:8px;font-size:.7rem;text-align:center;color:var(--muted)"></div>
  </div>

  <!-- APP -->
  <div id="appBox" class="hidden">
    <div class="user-bar">
      <span id="userEmail">‚Äî</span>
      <button class="btn-logout" onclick="logout()">D√âCONNEXION</button>
    </div>

    <div class="network-bar" id="networkBar">
      <div><span class="net-dot online" id="netDot"></span><span id="netLabel">WiFi connect√©</span></div>
      <span id="netSpeed">‚Äî MB/s</span>
    </div>

    <!-- Bandeau r√©seau coop√©ratif -->
    <div class="relay-bar" id="relayBar">
      <div class="relay-info">üåç R√©seau coop√©ratif</div>
      <div><span class="relay-count" id="relayCount">0</span> <span style="color:var(--muted);font-size:.6rem">n≈ìuds actifs</span></div>
    </div>

    <div class="battery-section" id="batterySection">
      <div class="battery-wrap">
        <div class="battery-tip"></div>
        <div class="battery-body" id="batteryBody">
          <div class="battery-fill" id="batteryFill"></div>
          <div class="bubble"></div><div class="bubble"></div><div class="bubble"></div>
          <div class="battery-percent" id="batteryPercent">0%</div>
          <div class="battery-label" id="batteryLabel">BUFFER VIDE</div>
        </div>
      </div>
      <div class="battery-stats">
        <div class="stat"><div class="stat-val" id="statUsed">0 MB</div><div class="stat-lbl">Stock√©</div></div>
        <div class="stat"><div class="stat-val" id="statTotal">100 GB</div><div class="stat-lbl">Capacit√©</div></div>
        <div class="stat"><div class="stat-val" id="statTime">0h</div><div class="stat-lbl">Autonomie</div></div>
      </div>
      <div class="mode-badge standby" id="modeBadge">
        <div class="mode-dot"></div><span id="modeLabel">En attente</span>
      </div>
    </div>

    <div class="controls">
      <button class="btn btn-charge" id="btnCharge" onclick="startCharge()">
        <span class="btn-icon">‚ö°</span>CHARGER
      </button>
      <button class="btn btn-discharge" id="btnDischarge" onclick="startDischarge()">
        <span class="btn-icon">üì°</span>D√âCHARGER
      </button>
    </div>

    <button class="btn-hotspot" id="btnHotspot" onclick="toggleHotspot()">
      <span>üì∂</span><span id="hotspotLabel">PARTAGER LA CONNEXION</span>
    </button>

    <div class="log-section">
      <div class="log-header"><div class="log-dot"></div>JOURNAL SYST√àME</div>
      <div class="log-body" id="logBody">
        <div class="log-line info">[ BUFFERWAVE v2.0 ] ‚Äî Syst√®me initialis√©</div>
      </div>
    </div>
  </div>
</div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

// ============================================================
// CONFIGURATION
// ============================================================
const SUPABASE_URL = 'https://udmmtyczhxqscgigrden.supabase.co'
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVkbW10eWN6aHhxc2NnaWdyZGVuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE2NzY5ODgsImV4cCI6MjA4NzI1Mjk4OH0.VrLhrYQgy31EsstVXLeeVVVYP5iMvsYG5Sel0hp6dgI'
const FLYIO_SERVER = 'https://bufferwave-network.fly.dev'

const supabase = createClient(SUPABASE_URL, SUPABASE_KEY)

// ============================================================
// √âTAT GLOBAL
// ============================================================
const STATE = {
  mode: 'standby',
  bufferMB: 0,
  totalMB: 102400,
  hotspot: false,
  online: navigator.onLine,
  chargeInterval: null,
  dischargeInterval: null,
  heartbeatInterval: null,
  relayInterval: null,
  userId: null,
  deviceId: null,
  userEmail: null,
  currentRelay: null,
  nodesActifs: 0
}

// ============================================================
// JOURNAL
// ============================================================
function log(msg, type = 'info') {
  const body = document.getElementById('logBody')
  const ts = new Date().toLocaleTimeString('fr-FR')
  const line = document.createElement('div')
  line.className = `log-line ${type}`
  line.textContent = `[${ts}] ${msg}`
  body.prepend(line)
  while (body.children.length > 50) body.removeChild(body.lastChild)
}

function fmt(mb) {
  return mb >= 1024 ? (mb / 1024).toFixed(1) + ' GB' : Math.round(mb) + ' MB'
}

// ============================================================
// MISE √Ä JOUR INTERFACE
// ============================================================
function updateUI() {
  const pct = Math.round((STATE.bufferMB / STATE.totalMB) * 100)
  document.getElementById('batteryFill').style.height = pct + '%'
  document.getElementById('batteryPercent').textContent = pct + '%'
  document.getElementById('statUsed').textContent = fmt(STATE.bufferMB)
  document.getElementById('statTime').textContent = Math.round(STATE.bufferMB / 150) + 'h'
  const lbl = pct === 0 ? 'BUFFER VIDE' : pct < 30 ? 'FAIBLE' : pct < 70 ? 'MOYEN' : pct < 100 ? '√âLEV√â' : 'PLEIN'
  document.getElementById('batteryLabel').textContent = lbl
  const badge = document.getElementById('modeBadge')
  const sec = document.getElementById('batterySection')
  badge.className = 'mode-badge'
  sec.className = 'battery-section'
  if (STATE.mode === 'charging') {
    badge.classList.add('charging')
    document.getElementById('modeLabel').textContent = 'Phase CHARGE'
    sec.classList.add('mode-charge')
  } else if (STATE.mode === 'discharging') {
    badge.classList.add('discharging')
    document.getElementById('modeLabel').textContent = 'Phase D√âCHARGE'
  } else {
    badge.classList.add('standby')
    document.getElementById('modeLabel').textContent = 'En attente'
  }
  document.getElementById('btnCharge').classList.toggle('active', STATE.mode === 'charging')
  document.getElementById('btnDischarge').classList.toggle('active', STATE.mode === 'discharging')
  document.getElementById('relayCount').textContent = STATE.nodesActifs
}

// ============================================================
// SERVEUR FLY.IO ‚Äî Enregistrer comme n≈ìud du r√©seau
// ============================================================
async function registerNode() {
  if (!STATE.userId) return
  try {
    const res = await fetch(`${FLYIO_SERVER}/register`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        userId: STATE.userId,
        country: Intl.DateTimeFormat().resolvedOptions().timeZone,
        bandwidthMbps: 10,
        publicKey: STATE.userId,
        familyGroup: STATE.userEmail
      })
    })
    const data = await res.json()
    STATE.nodesActifs = data.nodesActifs || 0
    updateUI()
    log(`üåç Enregistr√© ‚Äî ${STATE.nodesActifs} n≈ìud(s) actif(s) dans le r√©seau`, 'success')
    if (data.messagesDTNLiberes > 0) {
      log(`üõ∏ ${data.messagesDTNLiberes} messages DTN lib√©r√©s`, 'success')
    }
  } catch (e) {
    log('Serveur r√©seau hors ligne ‚Äî mode local', 'warn')
  }
}

// ============================================================
// HEARTBEAT ‚Äî Maintenir la pr√©sence dans le r√©seau
// ============================================================
function startHeartbeat() {
  if (STATE.heartbeatInterval) clearInterval(STATE.heartbeatInterval)
  STATE.heartbeatInterval = setInterval(async () => {
    try {
      await fetch(`${FLYIO_SERVER}/heartbeat`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ userId: STATE.userId })
      })
    } catch (e) {}
  }, 15000)
}

// ============================================================
// SURVEILLER LES N≈íUDS ACTIFS
// ============================================================
function startRelayMonitor() {
  if (STATE.relayInterval) clearInterval(STATE.relayInterval)
  STATE.relayInterval = setInterval(async () => {
    try {
      const res = await fetch(`${FLYIO_SERVER}/nodes`)
      const data = await res.json()
      const avant = STATE.nodesActifs
      STATE.nodesActifs = data.total || 0
      if (STATE.nodesActifs !== avant) updateUI()
    } catch (e) {}
  }, 10000)
}

// ============================================================
// CONNEXION AU R√âSEAU COOP√âRATIF (pour Jean en for√™t)
// ============================================================
async function connectToCooperativeNetwork() {
  try {
    log('üîç Recherche d\'un n≈ìud disponible...', 'info')
    const res = await fetch(`${FLYIO_SERVER}/connect`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        userId: STATE.userId,
        userProfile: {
          country: Intl.DateTimeFormat().resolvedOptions().timeZone,
          familyGroup: STATE.userEmail
        }
      })
    })
    const data = await res.json()

    if (data.success && data.mode === 'cooperative_relay') {
      STATE.currentRelay = data.relay
      log(`‚úÖ Connect√© via n≈ìud : ${data.relay.country}`, 'success')
      log(`üì° Bande passante disponible : ${data.relay.bandwidthMbps} Mbps`, 'info')
      document.getElementById('netLabel').textContent = `R√©seau coop√©ratif ‚Äî via ${data.relay.country}`
      document.getElementById('netDot').className = 'net-dot online'
      return true
    } else {
      // Mode DTN ‚Äî aucun n≈ìud disponible
      log('üõ∏ Mode DTN activ√© ‚Äî Jean-Paul = Curiosity sur Mars', 'warn')
      log('üíæ Messages stock√©s jusqu\'√† la prochaine fen√™tre', 'warn')
      document.getElementById('netLabel').textContent = 'Mode DTN ‚Äî en attente de signal'
      document.getElementById('netDot').className = 'net-dot offline'
      return false
    }
  } catch (e) {
    log('üõ∏ Isolation totale ‚Äî Mode DTN local activ√©', 'warn')
    return false
  }
}

// ============================================================
// SUPABASE SYNC
// ============================================================
async function syncSupabase() {
  if (!STATE.userId || !STATE.deviceId) return
  await supabase.from('buffer_state').upsert({
    user_id: STATE.userId,
    device_id: STATE.deviceId,
    mode: STATE.mode,
    buffer_used_mb: STATE.bufferMB,
    buffer_total_mb: STATE.totalMB,
    pourcentage: Math.round((STATE.bufferMB / STATE.totalMB) * 100),
    hotspot_active: STATE.hotspot
  }, { onConflict: 'device_id' })
}

// ============================================================
// AUTHENTIFICATION
// ============================================================
window.login = async function () {
  const email = document.getElementById('emailInput').value.trim()
  const pass = document.getElementById('passInput').value
  const msg = document.getElementById('authMsg')
  if (!email || !pass) { log('Email et mot de passe requis', 'error'); return }

  if (currentTab === 'register') {
    // INSCRIPTION
    const confirm = document.getElementById('passConfirm').value
    if (pass !== confirm) {
      msg.textContent = 'Les mots de passe ne correspondent pas'
      msg.style.color = '#ff4060'
      return
    }
    if (pass.length < 6) {
      msg.textContent = 'Mot de passe minimum 6 caract√®res'
      msg.style.color = '#ff4060'
      return
    }
    msg.textContent = 'Inscription en cours...'
    msg.style.color = '#ffaa00'
    const { data, error } = await supabase.auth.signUp({ email, password: pass })
    if (error) {
      msg.textContent = 'Erreur : ' + error.message
      msg.style.color = '#ff4060'
      log('Erreur inscription : ' + error.message, 'error')
      return
    }
    log('Compte cr√©√© ‚Äî bienvenue !', 'success')
    await initUser(data.user)
  } else {
    // CONNEXION
    msg.textContent = 'Connexion en cours...'
    msg.style.color = '#ffaa00'
    const { data, error } = await supabase.auth.signInWithPassword({ email, password: pass })
    if (error) {
      msg.textContent = 'Email ou mot de passe incorrect'
      msg.style.color = '#ff4060'
      log('Erreur connexion : ' + error.message, 'error')
      return
    }
    await initUser(data.user)
  }
}

window.logout = async function () {
  await supabase.auth.signOut()
  clearInterval(STATE.heartbeatInterval)
  clearInterval(STATE.relayInterval)
  // Se d√©connecter du r√©seau
  try {
    await fetch(`${FLYIO_SERVER}/disconnect`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ userId: STATE.userId })
    })
  } catch (e) {}
  STATE.userId = null
  document.getElementById('authBox').classList.remove('hidden')
  document.getElementById('appBox').classList.add('hidden')
  log('D√©connect√©', 'warn')
}

async function initUser(user) {
  STATE.userId = user.id
  STATE.userEmail = user.email
  document.getElementById('userEmail').textContent = user.email
  document.getElementById('authBox').classList.add('hidden')
  document.getElementById('appBox').classList.remove('hidden')

  // Appareil
  let { data: dev } = await supabase.from('devices').select('id').eq('user_id', user.id).limit(1)
  if (dev && dev.length > 0) {
    STATE.deviceId = dev[0].id
  } else {
    const { data: newDev } = await supabase.from('devices').insert({
      user_id: user.id,
      device_name: navigator.userAgent.includes('Mobile') ? 'Mobile' : 'Desktop',
      device_type: 'mobile'
    }).select('id').single()
    if (newDev) STATE.deviceId = newDev.id
  }

  // √âtat existant
  const { data: bs } = await supabase.from('buffer_state').select('*').eq('device_id', STATE.deviceId).single()
  if (bs) { STATE.bufferMB = bs.buffer_used_mb || 0 }

  updateUI()
  log('Connect√© ‚Äî buffer charg√© depuis Supabase', 'success')

  // Service Worker
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/sw.js').then(() => log('Service Worker actif', 'success'))
  }

  // S'enregistrer dans le r√©seau coop√©ratif
  await registerNode()

  // Heartbeat et moniteur
  startHeartbeat()
  startRelayMonitor()
}

// ============================================================
// CHARGER ‚Äî Jean est √† la maison sur WiFi
// Un seul clic ‚Äî tout se fait automatiquement
// ============================================================
window.startCharge = async function () {
  if (STATE.mode === 'charging') {
    stopAll()
    log('Charge arr√™t√©e', 'warn')
    return
  }
  if (!navigator.onLine) {
    log('‚ö† Pas de WiFi d√©tect√© ‚Äî impossible de charger', 'error')
    return
  }
  stopAll()
  STATE.mode = 'charging'
  log('‚ö° Phase CHARGE d√©marr√©e ‚Äî accumulation en cours', 'success')
  log('üì∂ Tout le trafic internet est captur√© automatiquement', 'info')

  // Enregistrer dans le r√©seau comme n≈ìud disponible
  await registerNode()

  STATE.chargeInterval = setInterval(async () => {
    if (STATE.bufferMB >= STATE.totalMB) {
      stopAll()
      log('‚úÖ Buffer PLEIN ‚Äî 100 GB accumul√©s', 'success')
      return
    }
    const rate = 50 + Math.random() * 150
    STATE.bufferMB = Math.min(STATE.bufferMB + rate, STATE.totalMB)
    document.getElementById('netSpeed').textContent = rate.toFixed(0) + ' MB/s'
    updateUI()
    if (Math.random() < 0.1) await syncSupabase()
  }, 1000)

  updateUI()
  navigator.serviceWorker.controller?.postMessage({ type: 'SET_MODE', mode: 'charging' })
  await supabase.from('sessions').insert({ user_id: STATE.userId, device_id: STATE.deviceId, type: 'charge' })
}

// ============================================================
// D√âCHARGER ‚Äî Jean est en for√™t
// Un seul clic ‚Äî connexion automatique via le r√©seau coop√©ratif
// ============================================================
window.startDischarge = async function () {
  if (STATE.mode === 'discharging') {
    stopAll()
    log('D√©charge arr√™t√©e', 'warn')
    return
  }
  if (STATE.bufferMB <= 0) {
    log('‚ö† Buffer vide ‚Äî chargez d\'abord √† la maison', 'error')
    return
  }
  stopAll()
  STATE.mode = 'discharging'
  log('üì° Phase D√âCHARGE activ√©e', 'success')
  log('üîç Connexion au r√©seau coop√©ratif...', 'info')

  // Connexion automatique via le r√©seau coop√©ratif
  const connected = await connectToCooperativeNetwork()

  if (connected) {
    log(`üåç Connexion √©tablie via ${STATE.currentRelay.country}`, 'success')
    log('‚úÖ Jean-Paul peut naviguer normalement', 'success')
  } else {
    log('üõ∏ DTN actif ‚Äî messages stock√©s jusqu\'au prochain signal', 'warn')
    log('‚ö° M√™me 1 seconde de signal suffit pour envoyer', 'info')
  }

  document.getElementById('netDot').className = 'net-dot offline'

  STATE.dischargeInterval = setInterval(async () => {
    if (STATE.bufferMB <= 0) {
      stopAll()
      log('‚ö† Buffer √©puis√©', 'error')
      return
    }
    const usage = 20 + Math.random() * 60
    STATE.bufferMB = Math.max(0, STATE.bufferMB - usage)
    document.getElementById('netSpeed').textContent = usage.toFixed(0) + ' MB/s'
    updateUI()
    if (Math.random() < 0.1) await syncSupabase()
  }, 1000)

  updateUI()
  navigator.serviceWorker.controller?.postMessage({ type: 'SET_MODE', mode: 'discharging' })
}

// ============================================================
// ARR√äT
// ============================================================
function stopAll() {
  clearInterval(STATE.chargeInterval)
  clearInterval(STATE.dischargeInterval)
  STATE.mode = 'standby'
  STATE.currentRelay = null
  document.getElementById('netSpeed').textContent = '‚Äî MB/s'
  document.getElementById('netDot').className = 'net-dot online'
  document.getElementById('netLabel').textContent = 'WiFi connect√©'
  syncSupabase()
  updateUI()
  navigator.serviceWorker.controller?.postMessage({ type: 'SET_MODE', mode: 'standby' })
}

// ============================================================
// PARTAGER LA CONNEXION
// ============================================================
window.toggleHotspot = async function () {
  STATE.hotspot = !STATE.hotspot
  const btn = document.getElementById('btnHotspot')
  const lbl = document.getElementById('hotspotLabel')
  if (STATE.hotspot) {
    btn.classList.add('active')
    lbl.textContent = 'PARTAGE ACTIF ‚Äî CLIQUER POUR ARR√äTER'
    log('üì∂ Connexion partag√©e avec le r√©seau coop√©ratif', 'success')
    await registerNode()
  } else {
    btn.classList.remove('active')
    lbl.textContent = 'PARTAGER LA CONNEXION'
    log('Partage arr√™t√©', 'warn')
  }
  await syncSupabase()
}

// ============================================================
// D√âTECTION R√âSEAU
// ============================================================
window.addEventListener('online', async () => {
  STATE.online = true
  document.getElementById('netDot').className = 'net-dot online'
  document.getElementById('netLabel').textContent = 'WiFi connect√©'
  log('‚úÖ WiFi d√©tect√© ‚Äî fen√™tre de communication ouverte', 'success')
  // Lib√©rer les messages DTN en attente
  await registerNode()
})

window.addEventListener('offline', () => {
  STATE.online = false
  if (STATE.mode === 'charging') {
    stopAll()
    log('WiFi perdu ‚Äî charge interrompue', 'error')
  }
  if (STATE.mode !== 'discharging') {
    log('üìµ Pas de r√©seau ‚Äî activez D√âCHARGER pour utiliser le buffer', 'warn')
  }
})

// ============================================================
// ONGLETS + OEIL MOT DE PASSE
// ============================================================
let currentTab = 'login'

window.switchTab = function(tab) {
  currentTab = tab
  const tL = document.getElementById('tabLogin')
  const tR = document.getElementById('tabRegister')
  const cb = document.getElementById('confirmBox')
  const ba = document.getElementById('btnAuth')
  const base = 'flex:1;padding:8px;border-radius:8px;font-family:Orbitron,monospace;font-size:.65rem;letter-spacing:2px;cursor:pointer;'
  if (tab === 'login') {
    tL.style.cssText = base + 'background:rgba(0,245,196,0.2);border:1px solid #00f5c4;color:#00f5c4'
    tR.style.cssText = base + 'background:transparent;border:1px solid #4a6080;color:#4a6080'
    cb.style.display = 'none'
    ba.textContent = 'SE CONNECTER'
  } else {
    tR.style.cssText = base + 'background:rgba(0,245,196,0.2);border:1px solid #00f5c4;color:#00f5c4'
    tL.style.cssText = base + 'background:transparent;border:1px solid #4a6080;color:#4a6080'
    cb.style.display = 'block'
    ba.textContent = "S'INSCRIRE"
  }
}

window.togglePass = function() {
  const inp = document.getElementById('passInput')
  const btn = document.getElementById('eyeBtn')
  inp.type = inp.type === 'password' ? 'text' : 'password'
  btn.textContent = inp.type === 'password' ? 'üëÅ' : 'üôà'
}

// Session existante
supabase.auth.getSession().then(({ data: { session } }) => {
  if (session) initUser(session.user)
})
</script>
</body>
</html>
